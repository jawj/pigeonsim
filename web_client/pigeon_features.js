// Generated by CoffeeScript 1.6.3
(function() {
  var box, load, mergeObj, oneEightyOverPi, _ref, _ref1, _ref10, _ref11, _ref12, _ref13, _ref14, _ref15, _ref16, _ref17, _ref18, _ref19, _ref2, _ref20, _ref21, _ref22, _ref23, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.load = load = function(opts, callback) {
    var k, kvps, url, v, xhr;
    url = opts.url;
    if (opts.method == null) {
      opts.method = 'GET';
    }
    if (opts.search != null) {
      kvps = (function() {
        var _ref, _results;
        _ref = opts.search;
        _results = [];
        for (k in _ref) {
          if (!__hasProp.call(_ref, k)) continue;
          v = _ref[k];
          _results.push("" + (escape(k)) + "=" + (escape(v)));
        }
        return _results;
      })();
      url += '?' + kvps.join('&');
    }
    xhr = new XMLHttpRequest();
    if (opts.type === 'xml') {
      xhr.overrideMimeType('text/xml');
    }
    xhr.onreadystatechange = function() {
      var obj;
      if (xhr.readyState === 4) {
        obj = opts.type === 'json' ? JSON.parse(xhr.responseText) : opts.type === 'xml' ? xhr.responseXML : xhr.responseText;
        return callback(obj);
      }
    };
    xhr.open(opts.method, url, true);
    return xhr.send(opts.data);
  };

  mergeObj = function(o1, o2) {
    var k, v;
    for (k in o2) {
      if (!__hasProp.call(o2, k)) continue;
      v = o2[k];
      o1[k] = v;
    }
    return o1;
  };

  oneEightyOverPi = 180 / Math.PI;

  box = null;

  this.FeatureManager = (function() {
    function FeatureManager(ge, lonRatio, cam, params) {
      this.ge = ge;
      this.lonRatio = lonRatio;
      this.cam = cam;
      this.params = params;
      this.featureTree = new RTree();
      this.visibleFeatures = {};
      this.updateMoment = 0;
    }

    FeatureManager.prototype.addFeature = function(f) {
      f.fm = this;
      return this.featureTree.insert(f.rect(), f);
    };

    FeatureManager.prototype.removeFeature = function(f) {
      this.hideFeature(f);
      this.featureTree.remove(f.rect(), f);
      return delete f.fm;
    };

    FeatureManager.prototype.showFeature = function(f) {
      if (this.visibleFeatures[f.id] != null) {
        return false;
      }
      this.visibleFeatures[f.id] = f;
      f.show();
      return true;
    };

    FeatureManager.prototype.hideFeature = function(f) {
      if (this.visibleFeatures[f.id] == null) {
        return false;
      }
      delete this.visibleFeatures[f.id];
      f.hide();
      return true;
    };

    FeatureManager.prototype.featuresInBBox = function(lat1, lon1, lat2, lon2) {
      return this.featureTree.search({
        x: lon1,
        y: lat1,
        w: lon2 - lon1,
        h: lat2 - lat1
      });
    };

    FeatureManager.prototype.reset = function() {
      var f, id, _ref;
      _ref = this.visibleFeatures;
      for (id in _ref) {
        if (!__hasProp.call(_ref, id)) continue;
        f = _ref[id];
        this.hideFeature(f);
      }
      return this.update();
    };

    FeatureManager.prototype.update = function() {
      var cam, f, id, kml, lat1, lat2, latDiff, latSize, lon1, lon2, lonDiff, lonSize, lookAt, lookLat, lookLon, midLat, midLon, sizeFactor, _i, _len, _ref, _ref1;
      cam = this.cam;
      lookAt = this.ge.getView().copyAsLookAt(ge.ALTITUDE_ABSOLUTE);
      lookLat = lookAt.getLatitude();
      lookLon = lookAt.getLongitude();
      midLat = (cam.lat + lookLat) / 2;
      midLon = (cam.lon + lookLon) / 2;
      latDiff = Math.abs(cam.lat - midLat);
      lonDiff = Math.abs(cam.lon - midLon);
      sizeFactor = 1.2;
      latSize = Math.max(latDiff, lonDiff / this.lonRatio) * sizeFactor;
      lonSize = latSize * this.lonRatio;
      lat1 = midLat - latSize;
      lat2 = midLat + latSize;
      lon1 = midLon - lonSize;
      lon2 = midLon + lonSize;
      if (this.params.debugBox) {
        if (box) {
          this.ge.getFeatures().removeChild(box);
        }
        kml = "<?xml version='1.0' encoding='UTF-8'?><kml xmlns='http://www.opengis.net/kml/2.2'><Document><Placemark><name>lookAt</name><Point><coordinates>" + lookLon + "," + lookLat + ",0</coordinates></Point></Placemark><Placemark><name>camera</name><Point><coordinates>" + cam.lon + "," + cam.lat + ",0</coordinates></Point></Placemark><Placemark><name>middle</name><Point><coordinates>" + midLon + "," + midLat + ",0</coordinates></Point></Placemark><Placemark><LineString><altitudeMode>absolute</altitudeMode><coordinates>" + lon1 + "," + lat1 + ",100 " + lon1 + "," + lat2 + ",100 " + lon2 + "," + lat2 + ",100 " + lon2 + "," + lat1 + ",50 " + lon1 + "," + lat1 + ",100</coordinates></LineString></Placemark></Document></kml>";
        box = this.ge.parseKml(kml);
        this.ge.getFeatures().appendChild(box);
      }
      _ref = this.featuresInBBox(lat1, lon1, lat2, lon2);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        f = _ref[_i];
        this.showFeature(f);
        f.updateMoment = this.updateMoment;
      }
      _ref1 = this.visibleFeatures;
      for (id in _ref1) {
        if (!__hasProp.call(_ref1, id)) continue;
        f = _ref1[id];
        if (f.updateMoment < this.updateMoment) {
          this.hideFeature(f);
        }
      }
      return this.updateMoment += 1;
    };

    return FeatureManager;

  })();

  this.FeatureSet = (function() {
    function FeatureSet(featureManager) {
      this.featureManager = featureManager;
      this.features = {};
    }

    FeatureSet.prototype.addFeature = function(f) {
      this.features[f.id] = f;
      return this.featureManager.addFeature(f);
    };

    FeatureSet.prototype.removeFeature = function(f) {
      this.featureManager.removeFeature(f);
      return delete this.features[f.id];
    };

    FeatureSet.prototype.clearFeatures = function() {
      var f, k, _ref, _results;
      _ref = this.features;
      _results = [];
      for (k in _ref) {
        if (!__hasProp.call(_ref, k)) continue;
        f = _ref[k];
        _results.push(this.removeFeature(f));
      }
      return _results;
    };

    return FeatureSet;

  })();

  this.Feature = (function() {
    Feature.prototype.alt = 100;

    Feature.prototype.nameTextOpts = {};

    Feature.prototype.descTextOpts = {};

    function Feature(id, lat, lon, opts) {
      this.id = id;
      this.lat = lat;
      this.lon = lon;
      this.opts = opts;
    }

    Feature.prototype.rect = function() {
      return {
        x: this.lon,
        y: this.lat,
        w: 0,
        h: 0
      };
    };

    Feature.prototype.show = function() {
      var angleToCamDeg, angleToCamRad, cam, fm, ge, geNode, st;
      fm = this.fm;
      cam = fm.cam;
      ge = fm.ge;
      angleToCamRad = Math.atan2(this.lon - cam.lon, this.lat - cam.lat);
      angleToCamDeg = angleToCamRad * oneEightyOverPi;
      st = new SkyText(this.lat, this.lon, this.alt, this.opts);
      if (this.name) {
        st.text(this.name, mergeObj({
          bearing: angleToCamDeg
        }, this.nameTextOpts));
      }
      if (this.desc) {
        st.text(this.desc, mergeObj({
          bearing: angleToCamDeg
        }, this.descTextOpts));
      }
      geNode = ge.parseKml(st.kml());
      ge.getFeatures().appendChild(geNode);
      this.hide();
      return this.geNode = geNode;
    };

    Feature.prototype.hide = function() {
      if (this.geNode != null) {
        this.fm.ge.getFeatures().removeChild(this.geNode);
        return delete this.geNode;
      }
    };

    return Feature;

  })();

  this.RailStationSet = (function(_super) {
    __extends(RailStationSet, _super);

    function RailStationSet(featureManager) {
      var code, lat, lon, name, row, station, _i, _len, _ref, _ref1;
      RailStationSet.__super__.constructor.call(this, featureManager);
      _ref = this.csv.split("\n");
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        row = _ref[_i];
        _ref1 = row.split(','), code = _ref1[0], name = _ref1[1], lat = _ref1[2], lon = _ref1[3];
        if (lat < 51.253320526331336 || lat > 51.73383267274113 || lon < -0.61248779296875 || lon > 0.32684326171875) {
          continue;
        }
        station = new RailStation("rail-" + code, parseFloat(lat), parseFloat(lon));
        station.name = "\uF001 " + name;
        this.addFeature(station);
      }
    }

    return RailStationSet;

  })(FeatureSet);

  this.RailStation = (function(_super) {
    __extends(RailStation, _super);

    function RailStation() {
      _ref = RailStation.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    RailStation.prototype.alt = 130;

    RailStation.prototype.nameTextOpts = {
      size: 3
    };

    return RailStation;

  })(Feature);

  this.DistanceSensorSet = (function(_super) {
    __extends(DistanceSensorSet, _super);

    function DistanceSensorSet(featureManager) {
      var dis_crystal, dis_event, dis_sensor, dis_sound_sensor, distance_wind_sensor, lat, lfs, lon, name, row, _i, _len, _ref1, _ref2;
      DistanceSensorSet.__super__.constructor.call(this, featureManager);
      dis_event = new DistanceEventLocation("excel center", 51.508208, 0.030958);
      dis_event.name = "ExCeL London";
      dis_event.desc = "International Convention Centre";
      this.addFeature(dis_event);
      dis_crystal = new DistanceEventLocation("The Crystal", 51.507474, 0.01633);
      dis_crystal.name = "The Crystal";
      dis_crystal.alt = 150;
      this.addFeature(dis_crystal);
      dis_sensor = new DistanceTempSensor("Temp Sensor", 51.508168, 0.026473);
      this.addFeature(dis_sensor);
      dis_sensor.update();
      distance_wind_sensor = new DistanceWindSensor("Wind Sensor", 51.508762, 0.028759);
      this.addFeature(distance_wind_sensor);
      distance_wind_sensor.update();
      dis_sound_sensor = new DistanceSoundSensor("Sound Sensor", 51.508208, 0.030459);
      this.addFeature(dis_sound_sensor);
      dis_sound_sensor.update();
      _ref1 = this.csv.split("\n");
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        row = _ref1[_i];
        _ref2 = row.split(','), lat = _ref2[0], lon = _ref2[1], name = _ref2[2];
        lfs = new LeedsFeature(name, parseFloat(lat), parseFloat(lon));
        lfs.name = name;
        this.addFeature(lfs);
      }
    }

    return DistanceSensorSet;

  })(FeatureSet);

  this.DistanceEventLocation = (function(_super) {
    __extends(DistanceEventLocation, _super);

    function DistanceEventLocation() {
      _ref1 = DistanceEventLocation.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    DistanceEventLocation.prototype.alt = 210;

    DistanceEventLocation.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    DistanceEventLocation.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return DistanceEventLocation;

  })(Feature);

  this.DistanceFeature = (function(_super) {
    __extends(DistanceFeature, _super);

    function DistanceFeature() {
      _ref2 = DistanceFeature.__super__.constructor.apply(this, arguments);
      return _ref2;
    }

    DistanceFeature.prototype.alt = Math.floor(Math.random() * (300 - 200 + 1) + 200);

    DistanceFeature.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    DistanceFeature.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return DistanceFeature;

  })(Feature);

  this.DistanceTempSensor = (function(_super) {
    __extends(DistanceTempSensor, _super);

    function DistanceTempSensor() {
      _ref3 = DistanceTempSensor.__super__.constructor.apply(this, arguments);
      return _ref3;
    }

    DistanceTempSensor.prototype.alt = 200;

    DistanceTempSensor.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    DistanceTempSensor.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    DistanceTempSensor.prototype.name = "Intel Weather Station";

    DistanceTempSensor.prototype.update = function() {
      var self,
        _this = this;
      if (this.geNode != null) {
        this.show();
      }
      load({
        url: 'http://ios.stevenjamesgray.com/dataFeed/?feed=491325353&stream=Inside_air_temperature.json',
        type: 'json'
      }, function(data) {
        _this.desc = "Temperature: " + data.current_value + data.unit.symbol;
        if (_this.geNode != null) {
          return _this.show();
        }
      });
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 10 * 1000);
      }
    };

    return DistanceTempSensor;

  })(Feature);

  this.DistanceWindSensor = (function(_super) {
    __extends(DistanceWindSensor, _super);

    function DistanceWindSensor() {
      _ref4 = DistanceWindSensor.__super__.constructor.apply(this, arguments);
      return _ref4;
    }

    DistanceWindSensor.prototype.alt = 110;

    DistanceWindSensor.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    DistanceWindSensor.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    DistanceWindSensor.prototype.name = "Intel Weather Station";

    DistanceWindSensor.prototype.update = function() {
      var self,
        _this = this;
      if (this.geNode != null) {
        this.show();
      }
      load({
        url: 'http://ios.stevenjamesgray.com/dataFeed/?feed=491325353&stream=Wind_Speed.json',
        type: 'json'
      }, function(data) {
        _this.desc = "Wind Speed: " + data.current_value + data.unit.symbol;
        if (_this.geNode != null) {
          return _this.show();
        }
      });
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 10 * 1000);
      }
    };

    return DistanceWindSensor;

  })(Feature);

  this.DistanceSoundSensor = (function(_super) {
    __extends(DistanceSoundSensor, _super);

    function DistanceSoundSensor() {
      _ref5 = DistanceSoundSensor.__super__.constructor.apply(this, arguments);
      return _ref5;
    }

    DistanceSoundSensor.prototype.alt = 150;

    DistanceSoundSensor.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    DistanceSoundSensor.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    DistanceSoundSensor.prototype.name = "GPRS LogBook";

    DistanceSoundSensor.prototype.update = function() {
      var self,
        _this = this;
      if (this.geNode != null) {
        this.show();
      }
      load({
        url: 'http://ios.stevenjamesgray.com/dataFeed/?feed=804611207&stream=230908.json',
        type: 'json'
      }, function(data) {
        _this.desc = "Sound Level: " + data.current_value + data.unit.symbol;
        if (_this.geNode != null) {
          return _this.show();
        }
      });
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 10 * 1000);
      }
    };

    return DistanceSoundSensor;

  })(Feature);

  this.ParisCitySet = (function(_super) {
    __extends(ParisCitySet, _super);

    function ParisCitySet(featureManager) {
      var lat, lfs, lon, name, row, _i, _len, _ref6, _ref7;
      ParisCitySet.__super__.constructor.call(this, featureManager);
      _ref6 = this.csv.split("\n");
      for (_i = 0, _len = _ref6.length; _i < _len; _i++) {
        row = _ref6[_i];
        _ref7 = row.split(','), lat = _ref7[0], lon = _ref7[1], name = _ref7[2];
        lfs = new ParisFeature(name, parseFloat(lat), parseFloat(lon));
        lfs.name = name;
        this.addFeature(lfs);
      }
    }

    return ParisCitySet;

  })(FeatureSet);

  this.ParisFeature = (function(_super) {
    __extends(ParisFeature, _super);

    function ParisFeature() {
      _ref6 = ParisFeature.__super__.constructor.apply(this, arguments);
      return _ref6;
    }

    ParisFeature.prototype.alt = Math.floor(Math.random() * (300 - 200 + 1) + 200);

    ParisFeature.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    ParisFeature.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return ParisFeature;

  })(Feature);

  this.LeedsCitySet = (function(_super) {
    __extends(LeedsCitySet, _super);

    function LeedsCitySet(featureManager) {
      var bb, lat, lch, lfs, lon, name, railLeeds, row, unileeds, _i, _len, _ref7, _ref8;
      LeedsCitySet.__super__.constructor.call(this, featureManager);
      lch = new LeedsCivicHall("civic-hall", 53.80210025576234, -1.5485385060310364);
      this.addFeature(lch);
      unileeds = new UniLeeds("uni-of-leeds", 53.80786737971994, -1.5527737140655518);
      this.addFeature(unileeds);
      railLeeds = new RailLeeds("RailStation", 53.79437097083624, -1.5475326776504517);
      railLeeds.update();
      this.addFeature(railLeeds);
      bb = new LeedsTownHallClock('TownHallClock', 53.80005678340009, -1.5497106313705444);
      bb.update();
      this.addFeature(bb);
      _ref7 = this.csv.split("\n");
      for (_i = 0, _len = _ref7.length; _i < _len; _i++) {
        row = _ref7[_i];
        _ref8 = row.split(','), lat = _ref8[0], lon = _ref8[1], name = _ref8[2];
        lfs = new LeedsFeature(name, parseFloat(lat), parseFloat(lon));
        lfs.name = name;
        this.addFeature(lfs);
      }
    }

    return LeedsCitySet;

  })(FeatureSet);

  this.LeedsFeature = (function(_super) {
    __extends(LeedsFeature, _super);

    function LeedsFeature() {
      _ref7 = LeedsFeature.__super__.constructor.apply(this, arguments);
      return _ref7;
    }

    LeedsFeature.prototype.alt = Math.floor(Math.random() * (300 - 200 + 1) + 200);

    LeedsFeature.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    LeedsFeature.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return LeedsFeature;

  })(Feature);

  this.LeedsCivicHall = (function(_super) {
    __extends(LeedsCivicHall, _super);

    function LeedsCivicHall() {
      _ref8 = LeedsCivicHall.__super__.constructor.apply(this, arguments);
      return _ref8;
    }

    LeedsCivicHall.prototype.alt = 150;

    LeedsCivicHall.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    LeedsCivicHall.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    LeedsCivicHall.prototype.name = "Leeds Civic Hall";

    LeedsCivicHall.prototype.desc = "";

    return LeedsCivicHall;

  })(Feature);

  this.RailLeeds = (function(_super) {
    __extends(RailLeeds, _super);

    function RailLeeds() {
      _ref9 = RailLeeds.__super__.constructor.apply(this, arguments);
      return _ref9;
    }

    RailLeeds.prototype.alt = 200;

    RailLeeds.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    RailLeeds.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    RailLeeds.prototype.name = "\uF001 Leeds Rail Station";

    RailLeeds.prototype.desc = "Next Train: ";

    RailLeeds.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.maptube.org/realtime/leedsdeparturesservice.svc/leeds',
        type: 'json'
      }, function(data) {
        _this.desc = "Next Train: " + data.text.replace("Platform \?\? ", "");
        if (_this.geNode != null) {
          return _this.show();
        }
      });
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 3 * 60 * 1000);
      }
    };

    return RailLeeds;

  })(Feature);

  this.UniLeeds = (function(_super) {
    __extends(UniLeeds, _super);

    function UniLeeds() {
      _ref10 = UniLeeds.__super__.constructor.apply(this, arguments);
      return _ref10;
    }

    UniLeeds.prototype.alt = 200;

    UniLeeds.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    UniLeeds.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    UniLeeds.prototype.name = "University of Leeds";

    UniLeeds.prototype.desc = "";

    return UniLeeds;

  })(Feature);

  this.LeedsTownHallClock = (function(_super) {
    __extends(LeedsTownHallClock, _super);

    function LeedsTownHallClock() {
      _ref11 = LeedsTownHallClock.__super__.constructor.apply(this, arguments);
      return _ref11;
    }

    LeedsTownHallClock.prototype.alt = 200;

    LeedsTownHallClock.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 2
    };

    LeedsTownHallClock.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    LeedsTownHallClock.prototype.update = function() {
      var self;
      this.name = new Date().strftime('%H.%M');
      this.desc = 'Leeds Town Hall';
      if (this.geNode != null) {
        this.show();
      }
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 1 * 60 * 1000);
      }
    };

    return LeedsTownHallClock;

  })(Feature);

  this.LeedsTweetSet = (function(_super) {
    __extends(LeedsTweetSet, _super);

    LeedsTweetSet.prototype.maxTweets = 500;

    function LeedsTweetSet(featureManager) {
      LeedsTweetSet.__super__.constructor.call(this, featureManager);
      this.update();
    }

    LeedsTweetSet.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.casa.ucl.ac.uk/tom/ajax-live/leeds_last_hour.json',
        type: 'json'
      }, function(data) {
        var dedupedTweets, i, k, lat, lon, t, tweet, _i, _len, _ref12, _results;
        _this.clearFeatures();
        dedupedTweets = {};
        _ref12 = data.results.slice(-_this.maxTweets);
        for (i = _i = 0, _len = _ref12.length; _i < _len; i = ++_i) {
          t = _ref12[i];
          dedupedTweets["" + (parseFloat(t.lat).toFixed(4)) + "/" + (parseFloat(t.lon).toFixed(4))] = t;
        }
        _results = [];
        for (k in dedupedTweets) {
          if (!__hasProp.call(dedupedTweets, k)) continue;
          t = dedupedTweets[k];
          lat = parseFloat(t.lat);
          lon = parseFloat(t.lon);
          if (isNaN(lat) || isNaN(lon)) {
            continue;
          }
          tweet = new Tweet("tweet-" + t.twitterID, lat, lon);
          tweet.name = "" + t.name + " — " + (t.dateT.match(/\d?\d:\d\d/));
          tweet.desc = t.twitterPost.replace(/&gt;/g, '>').replace(/&lt;/g, '<').match(/.{1,35}(\s|$)|\S+?(\s|$)/g).join('\n').replace(/\n+/g, '\n');
          _results.push(_this.addFeature(tweet));
        }
        return _results;
      });
      self = arguments.callee.bind(this);
      return setTimeout(self, 5 * 60 * 1000);
    };

    return LeedsTweetSet;

  })(FeatureSet);

  this.TubeStationSet = (function(_super) {
    __extends(TubeStationSet, _super);

    function TubeStationSet(featureManager) {
      var code, dummy, lat, lon, name, row, station, _i, _len, _ref12, _ref13;
      TubeStationSet.__super__.constructor.call(this, featureManager);
      _ref12 = this.csv.split("\n");
      for (_i = 0, _len = _ref12.length; _i < _len; _i++) {
        row = _ref12[_i];
        _ref13 = row.split(','), code = _ref13[0], dummy = _ref13[1], lon = _ref13[2], lat = _ref13[3], name = _ref13[4];
        station = new TubeStation("tube-" + code, parseFloat(lat), parseFloat(lon));
        station.name = "\uF000 " + name;
        this.addFeature(station);
      }
    }

    return TubeStationSet;

  })(FeatureSet);

  this.TubeStation = (function(_super) {
    __extends(TubeStation, _super);

    function TubeStation() {
      _ref12 = TubeStation.__super__.constructor.apply(this, arguments);
      return _ref12;
    }

    TubeStation.prototype.alt = 100;

    TubeStation.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return TubeStation;

  })(Feature);

  this.MiscSet = (function(_super) {
    __extends(MiscSet, _super);

    function MiscSet(featureManager) {
      var bb, ch, logo, tb;
      MiscSet.__super__.constructor.call(this, featureManager);
      ch = new CityHall("city-hall", 51.50477580586208, -0.07864236831665039);
      this.addFeature(ch);
      logo = new CASALogo("casa-logo", 51.52192375643773, -0.13593167066574097);
      this.addFeature(logo);
      bb = new BigBen('big-ben', 51.5007286626542, -0.12459531426429749);
      bb.update();
      this.addFeature(bb);
      tb = new TowerBridge('twr-brdg', 51.50558385576479, -0.0754237174987793);
      tb.update();
      this.addFeature(tb);
    }

    return MiscSet;

  })(FeatureSet);

  this.CityHall = (function(_super) {
    __extends(CityHall, _super);

    function CityHall() {
      _ref13 = CityHall.__super__.constructor.apply(this, arguments);
      return _ref13;
    }

    CityHall.prototype.alt = 120;

    CityHall.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 2
    };

    CityHall.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    CityHall.prototype.name = "City Hall";

    CityHall.prototype.desc = "More London";

    return CityHall;

  })(Feature);

  this.CASALogo = (function(_super) {
    __extends(CASALogo, _super);

    function CASALogo() {
      _ref14 = CASALogo.__super__.constructor.apply(this, arguments);
      return _ref14;
    }

    CASALogo.prototype.alt = 220;

    CASALogo.prototype.nameTextOpts = {
      size: 1,
      lineWidth: 1
    };

    CASALogo.prototype.name = "\uF002";

    return CASALogo;

  })(Feature);

  this.CASAConf = (function(_super) {
    __extends(CASAConf, _super);

    function CASAConf() {
      _ref15 = CASAConf.__super__.constructor.apply(this, arguments);
      return _ref15;
    }

    CASAConf.prototype.alt = 130;

    CASAConf.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 3
    };

    CASAConf.prototype.descTextOpts = {
      size: 1,
      lineWidth: 2
    };

    CASAConf.prototype.name = 'CASA Smart Cities';

    CASAConf.prototype.update = function() {
      var changed, d, d0, dayHrs, dayMs, desc, i, self, session, _i, _len, _ref16;
      d = new Date();
      d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      dayMs = d - d0;
      dayHrs = dayMs / 1000 / 60 / 60;
      _ref16 = this.schedule;
      for (i = _i = 0, _len = _ref16.length; _i < _len; i = ++_i) {
        session = _ref16[i];
        if (dayHrs < session[0]) {
          desc = "Now:\t" + this.schedule[i - 1][1] + "\nNext:\t" + session[1];
          break;
        }
      }
      changed = this.desc !== desc;
      this.desc = desc;
      if (changed && (this.geNode != null)) {
        this.show();
      }
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 1 * 60 * 1000);
      }
    };

    return CASAConf;

  })(Feature);

  this.TubeStation = (function(_super) {
    __extends(TubeStation, _super);

    function TubeStation() {
      _ref16 = TubeStation.__super__.constructor.apply(this, arguments);
      return _ref16;
    }

    TubeStation.prototype.alt = 100;

    TubeStation.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return TubeStation;

  })(Feature);

  this.BigBen = (function(_super) {
    __extends(BigBen, _super);

    function BigBen() {
      _ref17 = BigBen.__super__.constructor.apply(this, arguments);
      return _ref17;
    }

    BigBen.prototype.alt = 200;

    BigBen.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 2
    };

    BigBen.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    BigBen.prototype.update = function() {
      var self;
      this.name = new Date().strftime('%H.%M');
      this.desc = 'Big Ben';
      if (this.geNode != null) {
        this.show();
      }
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 1 * 60 * 1000);
      }
    };

    return BigBen;

  })(Feature);

  this.TowerBridge = (function(_super) {
    __extends(TowerBridge, _super);

    function TowerBridge() {
      _ref18 = TowerBridge.__super__.constructor.apply(this, arguments);
      return _ref18;
    }

    TowerBridge.prototype.alt = 150;

    TowerBridge.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 3
    };

    TowerBridge.prototype.name = 'Tower Bridge';

    TowerBridge.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.towerbridge.org.uk/TBE/EN/BridgeLiftTimes/',
        type: 'xml'
      }, function(data) {
        var cells, changed, desc, descs, i, x;
        cells = (function() {
          var _i, _len, _ref19, _results;
          _ref19 = data.querySelectorAll('td');
          _results = [];
          for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
            x = _ref19[_i];
            _results.push(x.innerHTML);
          }
          return _results;
        })();
        descs = (function() {
          var _i, _results;
          _results = [];
          for (i = _i = 0; _i <= 5; i = _i += 5) {
            _results.push("" + cells[i + 4] + " on " + cells[i] + " " + cells[i + 1] + " at " + cells[i + 2] + " for vessel " + cells[i + 3]);
          }
          return _results;
        })();
        desc = descs.join('\n');
        changed = _this.desc !== desc;
        _this.desc = desc;
        if (changed && (_this.geNode != null)) {
          return _this.show();
        }
      });
      self = arguments.callee.bind(this);
      if (this.interval == null) {
        return this.interval = setInterval(self, 4 * 60 * 60 * 1000);
      }
    };

    return TowerBridge;

  })(Feature);

  this.LondonTweetSet = (function(_super) {
    __extends(LondonTweetSet, _super);

    LondonTweetSet.prototype.maxTweets = 500;

    function LondonTweetSet(featureManager) {
      LondonTweetSet.__super__.constructor.call(this, featureManager);
      this.update();
    }

    LondonTweetSet.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.casa.ucl.ac.uk/tom/ajax-live/lon_last_hour.json',
        type: 'json'
      }, function(data) {
        var dedupedTweets, i, k, lat, lon, t, tweet, _i, _len, _ref19, _results;
        _this.clearFeatures();
        dedupedTweets = {};
        _ref19 = data.results.slice(-_this.maxTweets);
        for (i = _i = 0, _len = _ref19.length; _i < _len; i = ++_i) {
          t = _ref19[i];
          dedupedTweets["" + (parseFloat(t.lat).toFixed(4)) + "/" + (parseFloat(t.lon).toFixed(4))] = t;
        }
        _results = [];
        for (k in dedupedTweets) {
          if (!__hasProp.call(dedupedTweets, k)) continue;
          t = dedupedTweets[k];
          lat = parseFloat(t.lat);
          lon = parseFloat(t.lon);
          if (isNaN(lat) || isNaN(lon)) {
            continue;
          }
          tweet = new Tweet("tweet-" + t.twitterID, lat, lon);
          tweet.name = "" + t.name + " — " + (t.dateT.match(/\d?\d:\d\d/));
          tweet.desc = t.twitterPost.replace(/&gt;/g, '>').replace(/&lt;/g, '<').match(/.{1,35}(\s|$)|\S+?(\s|$)/g).join('\n').replace(/\n+/g, '\n');
          _results.push(_this.addFeature(tweet));
        }
        return _results;
      });
      self = arguments.callee.bind(this);
      return setTimeout(self, 5 * 60 * 1000);
    };

    return LondonTweetSet;

  })(FeatureSet);

  this.Tweet = (function(_super) {
    __extends(Tweet, _super);

    function Tweet() {
      _ref19 = Tweet.__super__.constructor.apply(this, arguments);
      return _ref19;
    }

    Tweet.prototype.alt = 160;

    Tweet.prototype.nameTextOpts = {
      size: 1
    };

    Tweet.prototype.descTextOpts = {
      size: 1,
      lineWidth: 1
    };

    return Tweet;

  })(Feature);

  this.LondonAirSet = (function(_super) {
    __extends(LondonAirSet, _super);

    function LondonAirSet(featureManager) {
      LondonAirSet.__super__.constructor.call(this, featureManager);
      this.update();
    }

    LondonAirSet.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.citydashboard.org/modules/airquality.php?city=london&format=csv'
      }, function(csv) {
        var a, cells, desc, headers, line, lines, metadata, no2desc, no2ugm3, o3desc, o3ugm3, pm10desc, pm10ugm3, _i, _len, _results;
        _this.clearFeatures();
        lines = csv.split('\n');
        metadata = lines.shift();
        headers = lines.shift();
        _results = [];
        for (_i = 0, _len = lines.length; _i < _len; _i++) {
          line = lines[_i];
          cells = line.split(',');
          if (cells.length < 10) {
            continue;
          }
          a = new LondonAir("air-" + cells[0], parseFloat(cells[3]), parseFloat(cells[4]));
          a.name = cells[1];
          desc = '';
          pm10ugm3 = cells[21];
          if (pm10ugm3 !== '') {
            pm10desc = cells[23];
            desc += "PM10:\t" + pm10ugm3 + " μg/m³ (" + pm10desc + ")\n";
          }
          no2ugm3 = cells[9];
          if (no2ugm3 !== '') {
            no2desc = cells[11];
            desc += "NO₂:\t" + no2ugm3 + " μg/m³ (" + no2desc + ")\n";
          }
          o3ugm3 = cells[5];
          if (o3ugm3 !== '') {
            o3desc = cells[7];
            desc += "O₃: \t" + o3ugm3 + " μg/m³ (" + o3desc + ")\n";
          }
          a.desc = desc;
          _results.push(_this.addFeature(a));
        }
        return _results;
      });
      self = arguments.callee.bind(this);
      return setTimeout(self, 10 * 60 * 1000);
    };

    return LondonAirSet;

  })(FeatureSet);

  this.LondonAir = (function(_super) {
    __extends(LondonAir, _super);

    function LondonAir() {
      _ref20 = LondonAir.__super__.constructor.apply(this, arguments);
      return _ref20;
    }

    LondonAir.prototype.alt = 180;

    LondonAir.prototype.nameTextOpts = {
      size: 2
    };

    LondonAir.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return LondonAir;

  })(Feature);

  this.LondonTrafficSet = (function(_super) {
    __extends(LondonTrafficSet, _super);

    function LondonTrafficSet(featureManager) {
      LondonTrafficSet.__super__.constructor.call(this, featureManager);
      this.update();
    }

    LondonTrafficSet.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.citydashboard.org/modules/roadsigns.php?city=london&format=csv'
      }, function(csv) {
        var a, cells, headers, line, lines, metadata, s, _i, _len, _results;
        _this.clearFeatures();
        lines = csv.split('\n');
        metadata = lines.shift();
        headers = lines.shift();
        _results = [];
        for (_i = 0, _len = lines.length; _i < _len; _i++) {
          line = lines[_i];
          cells = line.split(',');
          if (cells.length < 5) {
            continue;
          }
          a = new LondonTraffic("trf-" + cells[0], parseFloat(cells[3]), parseFloat(cells[4]));
          a.name = cells[11];
          a.desc = ((function() {
            var _j, _len1, _ref21, _results1;
            _ref21 = cells.slice(5, 9);
            _results1 = [];
            for (_j = 0, _len1 = _ref21.length; _j < _len1; _j++) {
              s = _ref21[_j];
              _results1.push(s.match(/^\s*(.*?)\s*$/)[1]);
            }
            return _results1;
          })()).join('\n');
          _results.push(_this.addFeature(a));
        }
        return _results;
      });
      self = arguments.callee.bind(this);
      return setTimeout(self, 3 * 60 * 1000);
    };

    return LondonTrafficSet;

  })(FeatureSet);

  this.LondonTraffic = (function(_super) {
    __extends(LondonTraffic, _super);

    function LondonTraffic() {
      _ref21 = LondonTraffic.__super__.constructor.apply(this, arguments);
      return _ref21;
    }

    LondonTraffic.prototype.alt = 150;

    LondonTraffic.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 2
    };

    LondonTraffic.prototype.descTextOpts = {
      size: 2,
      lineWidth: 1
    };

    return LondonTraffic;

  })(Feature);

  this.TideGaugeSet = (function(_super) {
    __extends(TideGaugeSet, _super);

    function TideGaugeSet(featureManager) {
      TideGaugeSet.__super__.constructor.call(this, featureManager);
      this.update();
    }

    TideGaugeSet.prototype.update = function() {
      var self,
        _this = this;
      load({
        url: 'http://www.citydashboard.org/modules/tide.php?city=london&format=csv'
      }, function(csv) {
        var a, cells, headers, line, lines, metadata, _i, _len, _results;
        _this.clearFeatures();
        lines = csv.split('\n');
        metadata = lines.shift();
        headers = lines.shift();
        _results = [];
        for (_i = 0, _len = lines.length; _i < _len; _i++) {
          line = lines[_i];
          cells = line.split(',');
          if (cells.length < 3) {
            continue;
          }
          a = new TideGauge("tide-" + cells[0], parseFloat(cells[3]), parseFloat(cells[4]));
          a.name = cells[1];
          a.desc = "Height:\t" + cells[5] + "m\nSurge:\t" + cells[6] + "m";
          _results.push(_this.addFeature(a));
        }
        return _results;
      });
      self = arguments.callee.bind(this);
      return setTimeout(self, 3 * 60 * 1000);
    };

    return TideGaugeSet;

  })(FeatureSet);

  this.TideGauge = (function(_super) {
    __extends(TideGauge, _super);

    function TideGauge() {
      _ref22 = TideGauge.__super__.constructor.apply(this, arguments);
      return _ref22;
    }

    TideGauge.prototype.alt = 80;

    TideGauge.prototype.nameTextOpts = {
      size: 2,
      lineWidth: 3
    };

    TideGauge.prototype.descTextOpts = {
      size: 2,
      lineWidth: 2
    };

    return TideGauge;

  })(Feature);

  this.OlympicSet = (function(_super) {
    __extends(OlympicSet, _super);

    function OlympicSet(featureManager) {
      var code, date, day, desc, end, lat, lon, name, row, sport, start, t1, t2, times, venue, _base, _i, _j, _len, _len1, _ref23, _ref24, _ref25, _ref26, _ref27;
      OlympicSet.__super__.constructor.call(this, featureManager);
      this.venues = [];
      this.events = {};
      _ref23 = this.venueData.split("\n");
      for (_i = 0, _len = _ref23.length; _i < _len; _i++) {
        row = _ref23[_i];
        _ref24 = row.split("\t"), lat = _ref24[0], lon = _ref24[1], name = _ref24[2];
        if (name === 'Multiple Venues' || name === 'Olympic Park') {
          continue;
        }
        this.venues.push({
          name: name,
          lat: parseFloat(lat),
          lon: parseFloat(lon)
        });
      }
      _ref25 = this.eventData.split("\n");
      for (_j = 0, _len1 = _ref25.length; _j < _len1; _j++) {
        row = _ref25[_j];
        _ref26 = row.split("\t"), day = _ref26[0], date = _ref26[1], times = _ref26[2], sport = _ref26[3], desc = _ref26[4], code = _ref26[5], venue = _ref26[6];
        _ref27 = times.split("-"), t1 = _ref27[0], t2 = _ref27[1];
        start = new Date("" + date + " " + t1);
        end = new Date("" + date + " " + t2);
        if ((_base = this.events)[venue] == null) {
          _base[venue] = [];
        }
        this.events[venue].push({
          start: start,
          end: end,
          sport: sport,
          desc: desc
        });
      }
      this.update();
    }

    OlympicSet.prototype.update = function() {
      var a, event, i, nextEvent, now, self, venue, _i, _j, _len, _len1, _ref23, _ref24, _ref25, _ref26;
      this.clearFeatures();
      _ref23 = this.venues;
      for (i = _i = 0, _len = _ref23.length; _i < _len; i = ++_i) {
        venue = _ref23[i];
        a = new OlympicVenue("oly-" + venue.name, venue.lat, venue.lon);
        a.name = "\uF003 " + venue.name;
        a.alt += (i % 5) * 30;
        if ((_ref24 = venue.name) !== 'Orbit') {
          now = new Date();
          nextEvent = null;
          _ref26 = (_ref25 = this.events[venue.name]) != null ? _ref25 : [];
          for (_j = 0, _len1 = _ref26.length; _j < _len1; _j++) {
            event = _ref26[_j];
            if (event.end > now) {
              nextEvent = event;
              break;
            }
          }
          if (nextEvent != null) {
            a.desc = nextEvent.start < now ? "Now: " + nextEvent.sport : "Next event: " + nextEvent.sport + ", " + (nextEvent.start.strftime("%a %d %b, %H:%M"));
          }
        }
        this.addFeature(a);
      }
      self = arguments.callee.bind(this);
      return setTimeout(self, 7 * 60 * 1000);
    };

    return OlympicSet;

  })(FeatureSet);

  this.OlympicVenue = (function(_super) {
    __extends(OlympicVenue, _super);

    function OlympicVenue() {
      _ref23 = OlympicVenue.__super__.constructor.apply(this, arguments);
      return _ref23;
    }

    OlympicVenue.prototype.alt = 120;

    OlympicVenue.prototype.nameTextOpts = {
      size: 3,
      lineWidth: 3
    };

    OlympicVenue.prototype.descTextOpts = {
      size: 2,
      lineWidth: 2
    };

    return OlympicVenue;

  })(Feature);

}).call(this);
